<?php
require 'php/getCharacter.php';
?>


<div class="row">

    <div id="character" class="container-fluid">

        <div class="row d-flex justify-content-center">
            <?php include "header.phtml" ?>
            <div id="statsChar " class="col-lg-3 col-md-8 col-sm-8 m-2 box">
                <h2>Stats</h2>
                <div class="statsItem">
                    <h3>Niveau : <span>
                            <?php echo $character->level ?></span></h3>
                </div>
                <div class="statsItem">
                    <h3 id="life" data-stats="<?php echo $character->vie ?>">Vie : <span id="persoVie">
                            <?php echo  $character->vie ?></span></h3>
                </div>
                <div class="statsItem">
                    <h3 id="attack" data-stats="<?php echo $character->attaque ?>">Attaque : <span id="persoAtt">
                            <?php echo $character->attaque ?></span></h3>
                </div>
                <div class="statsItem">
                    <h3 id="defense" data-stats="<?php echo $character->defense ?>">Défense : <span id="persoDef">
                            <?php echo $character->defense ?></span></h3>
                </div>
                <div class="statsItem">
                    <h3 id="critic" data-stats="<?php echo $character->critique ?>">Critique : <span id="persoCrit">
                            <?php echo  $character->critique ?>%</span></h3>
                </div>
            </div>

            <div id="vueChar" class="col-lg-5 col-md-8 col-sm-8 m-2 box" align="center ">
                <h2>
                    <?php echo $user->username ?>
                </h2>
                <div class="row d-flex justify-content-center">
                    <div id="helmet" class="col-lg-2 characterCell characterHead"></div>
                </div>
                <div class="row d-flex justify-content-center">
                    <div id="sword" class="col-lg-2 characterCell m-2 characterLeftArm"></div>
                    <div id="armour" class="col-lg-2 characterCell m-2 characterBody"></div>
                    <div id="shield" class="col-lg-2 characterCell m-2 characterRightArm"></div>
                </div>
                <div class="row d-flex justify-content-center">
                    <div id="boots" class="col-lg-2 characterCell m-2 characterLeg"></div>
                </div>
            </div>

            <div id="inventory" class="col-lg-3 col-md-8 col-sm-8 m-2 box">
                <h2>Inventaire </h2>
                <div class="trash"></div>
                <div class="validate"></div>
                <div class="cancel"></div>
                <div class="row d-flex justify-content-center">
                    <?php foreach ($detailsInv as $i){ ?>
                    <div class="col-lg-3 itemCell m-1" data-id="<?php echo $i->id_inventaire ?>" data-is_equip="<?php echo $i->is_equip ?>" data-item="<?php echo $i->type_equipement ?>" data-level="<?php echo $i->level_min ?>" data-attaque="<?php echo $i->attaque ?>" data-defense="<?php echo $i->defense ?>" data-critique="<?php echo $i->critique ?>" data-vie="<?php echo $i->vie ?>">
                        <img class="itemImg" src="img/<?php echo  $i->img ?>">
                        <div id="overlay<?php echo  $cmpt ?>" class="overlay">
                            <div>
                                <h3>
                                    <?php echo  $i->nom_equipement ?>
                                </h3>
                            </div>
                            <div>
                                <div>
                                    <h3>Level : <span>
                                            <?php echo  $i->level_min ?></span></h3>
                                </div>
                                <div>
                                    <h3>Attaque : <span>
                                            <?php echo  $i->attaque ?></span></h3>
                                </div>
                                <div>
                                    <h3>Defense : <span>
                                            <?php echo  $i->defense ?></span></h3>
                                </div>
                                <div>
                                    <h3>Critique : <span>
                                            <?php echo  $i->critique ?></span></h3>
                                </div>
                                <div>
                                    <h3>Vie : <span>
                                            <?php echo  $i->vie ?></span></h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    <?php $cmpt += 1; } ?>
                </div>

            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    var character = <?php echo json_encode($character, JSON_FORCE_OBJECT) ?>;
    var listInv = <?php echo json_encode($detailsInv) ?>;
    var trashOrNot = false;

    function showOverlay() {
        $(".itemCell").hover(function() {
            $(this).children().show();
        });
        $(".itemCell").mouseleave(function() {
            $(this).children(".overlay").hide();
        });
    }

    function addItem() {
        $(".itemCell").click(function() {
            var item = $(this);
            var itemType = $(this).data("item");
            var attInv = $(this).data("attaque");
            var defInv = $(this).data("defense");
            var critInv = $(this).data("critique");
            var lvlInv = $(this).data("level");
            var vieInv = $(this).data("vie");
            var id_item = $(this).data("id");
            var is_equip = $(this).data("is_equip");

            if ($(this).hasClass("trashableItem") && !$(this).hasClass("selectedTrashableItem")) {
                $(this).addClass("selectedTrashableItem");
                $(".validate").click(function() {
                    $(".itemCell").each(function() {
                        if ($(this).hasClass("selectedTrashableItem")) {
                            $(this).removeClass("trashableItem");
                            $(this).remove();
                            var id_inventaire = $(this).data('id');
                            $.ajax({
                                url: 'php/remove_item.php', // La ressource ciblée
                                type: 'POST', // Le type de la requête HTTP.
                                data: 'id_inventaire=' + id_inventaire
                            });
                        }
                    });

                });
                $(".cancel").click(function() {
                    $(".itemCell").each(function() {
                        $(this).removeClass("trashableItem");
                        $(this).removeClass("selectedTrashableItem");
                    });
                });
            } else if ($(this).hasClass("trashableItem") && $(this).hasClass("selectedTrashableItem")) {
                $(this).removeClass("selectedTrashableItem");
            } else {
                if (lvlInv <= character.level && is_equip == 0) {
                    if (itemType == 0) {
                        var charItem = $("#sword").children(".itemCell");
                    } else if (itemType == 1) {
                        var charItem = $("#helmet").children(".itemCell");
                    } else if (itemType == 2) {
                        var charItem = $("#armour").children(".itemCell");
                    } else if (itemType == 3) {
                        var charItem = $("#boots").children(".itemCell");
                    } else if (itemType == 4) {
                        var charItem = $("#shield").children(".itemCell");
                    }
                    var attPerso = charItem.data("attaque");
                    var defPerso = charItem.data("defense");
                    var critPerso = charItem.data("critique");
                    //var lvlPerso = charItem.data("level");
                    var viePerso = charItem.data("vie");
                    charItem.data("is_equip", 0);
                    $(this).data("is_equip", 1);

                    if (charItem.length == 1) {
                        character.attaque = parseInt(character.attaque) + parseInt(attInv) - parseInt(attPerso);
                        character.defense = parseInt(character.defense) + parseInt(defInv) - parseInt(defPerso);
                        character.critique = parseInt(character.critique) + parseInt(critInv) - parseInt(critPerso);
                        character.vie = parseInt(character.vie) + parseInt(vieInv) - parseInt(viePerso);
                        $.ajax({
                                url : 'php/unequip_item.php', // La ressource ciblée
                                type : 'POST', // Le type de la requête HTTP.
                                data : 'id_inventaire=' + charItem.data('id') + '&id_personnage='+ <?php echo $character->id_personnage ?>
                            });
                    } else {
                        character.attaque = parseInt(character.attaque) + parseInt(attInv);
                        character.defense = parseInt(character.defense) + parseInt(defInv);
                        character.critique = parseInt(character.critique) + parseInt(critInv);
                        character.vie = parseInt(character.vie) + parseInt(vieInv);
                    }
                    $.ajax({
                                url : 'php/equip_item.php', // La ressource ciblée
                                type : 'POST', // Le type de la requête HTTP.
                                data : 'id_inventaire=' + id_item + '&id_personnage='+ <?php echo $character->id_personnage ?>
                            });
                    console.log("toto");
                    $("#inventory").find(".row").append(charItem);
                    if (itemType == 0) {
                        $("#sword").append(item);
                    } else if (itemType == 1) {
                        $("#helmet").append(item);
                    } else if (itemType == 2) {
                        $("#armour").append(item);
                    } else if (itemType == 3) {
                        $("#boots").append(item);
                    } else if (itemType == 4) {
                        $("#shield").append(item);
                    }
                    $('#persoAtt').text(character.attaque);
                    $('#persoDef').text(character.defense);
                    $('#persoCrit').text(character.critique + "%");
                    $('#persoVie').text(character.vie);
                }
            }
        });
    }

    function removeItem() {
        $(".characterCell").click(function() {
            console.log("tata");
            var item = $(this).children(".itemCell");
            var attInv = item.data("attaque");
            var defInv = item.data("defense");
            var critInv = item.data("critique");
            var lvlInv = item.data("level");
            var vieInv = item.data("vie");
            item.data("is_equip", 0);
            character.attaque = parseInt(character.attaque) - parseInt(attInv);
            character.defense = parseInt(character.defense) - parseInt(defInv);
            character.critique = parseInt(character.critique) - parseInt(critInv);
            character.vie = parseInt(character.vie) - parseInt(vieInv);
            $('#persoAtt').text(character.attaque);
            $('#persoDef').text(character.defense);
            $('#persoCrit').text(character.critique + "%");
            $('#persoVie').text(character.vie);
            $("#inventory").find(".row").append(item);
            $.ajax({
                                url : 'php/unequip_item.php', // La ressource ciblée
                                type : 'POST', // Le type de la requête HTTP.
                                data : 'id_inventaire=' + item.data('id') + '&id_personnage='+ <?php echo $character->id_personnage ?>
                            });

        })
    }

    function trashItem() {
        $(".trash").click(function() {
            $(".overlay").css("opacity", 0);
            $(".validate").css("display", "inline-block");
            $(".cancel").css("display", "inline-block");
            $(".itemCell").addClass("trashableItem");

        });
        $(".validate").click(function() {
            $(".validate").css("display", "none");
            $(".cancel").css("display", "none");
            $(".overlay").css("opacity", 1);
            $(".itemCell").removeClass("trashableItem");
        });
        $(".cancel").click(function() {
            $(".overlay").css("opacity", 1);
            $(".validate").css("display", "none");
            $(".cancel").css("display", "none");
            $(".itemCell").removeClass("trashableItem");
        });
        $(".selectedTrashableItem").click(function() {

            console.log("selectedTrashableItem");
        });

    }

    function isEqup() {
        $(".itemCell").each(function() {
            if ($(this).data("is_equip") == "1") {
                if($(this).data("item") == "0"){
                    $("#sword").append($(this));
                }
                if($(this).data("item") == "1"){
                    $("#helmet").append($(this));
                }
                if($(this).data("item") == "2"){
                    $("#armour").append($(this));
                }
                if($(this).data("item") == "3"){
                    $("#boots").append($(this));
                }
                if($(this).data("item") == "4"){
                    $("#bouclier").append($(this));
                }
            }
        });
    }

    $(document).ready(function() {
        isEqup();
        trashItem();
        removeItem();
        addItem();
        showOverlay();
    })
</script>
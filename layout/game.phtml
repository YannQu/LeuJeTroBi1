<?php
require 'php/game.php';
/*var_dump($character);
var_dump($manche);
var_dump($ennemi);
var_dump($equipement);*/
?>
<script>
    class Personnage {
        constructor(span_vie, name, vie, attaque, defense, critique) {
            this.name = name;
            this.vie_max = vie;
            this.current_vie = vie;
            this.attaque = attaque;
            this.defense = defense;
            this.critique = critique;
            this.span_vie = span_vie;
        }

        goAttaque(cible, multiplicateur, txt) {
            console.log('attaque');
            var mult_critique = 1;
            var random_crit = getRandomInt(100) + 1;
            if (random_crit <= this.critique) {
                txt.innerHTML += this.name + " a fait un coup critique !</br>"
                mult_critique = 2;
            }
            var nb_dommage = this.attaque * multiplicateur * mult_critique - cible.defense;
            if (nb_dommage < 0) {
                nb_dommage = 0;
            }
            txt.innerHTML += this.name + " a fait une attaque de " + nb_dommage + " dégats.</br>";
            var rslt = cible.isAttaque(nb_dommage, txt);
            return rslt;
        }

        isAttaque(nb_dommage, txt) {
            this.current_vie -= nb_dommage;
            var rslt = true;
            if (this.current_vie <= 0) {
                this.current_vie = 0;
                txt.innerHTML += this.name + " est mort!</br>";
                rslt = false;
            }
            this.refreshLife();
            return rslt;
        }
        refreshLife() {
            var span_vie = document.getElementById(this.span_vie);
            span_vie.innerHTML = this.current_vie;
        }
    }
    var perso = new Personnage("vie_joueur", "<?php echo $user->username ; ?>", <?php echo $character->vie ; ?>, <?php echo $character->attaque ; ?>, <?php echo $character->defense ; ?>, <?php echo $character->critique; ?>);
    var ennemi = new Personnage("vie_ennemi", "<?php echo $ennemi->nom ; ?>", <?php echo $ennemi->vie ; ?>, <?php echo $ennemi->attaque ; ?>, <?php echo $ennemi->defense ; ?>, <?php echo $ennemi->critique; ?>);
    console.log(perso);
    console.log(ennemi);

    function getRandomInt(max) {
        return Math.floor(Math.random() * Math.floor(max));
    }

    function bataille(type_j) {
        var type = ['pierre', 'feuille', 'ciseaux'];
        var type_e = getRandomInt(3);
        var div_txt = document.getElementById("txt_bataille");
        div_txt.innerHTML += "Vous avez fait " + type[type_j] + "</br>";
        div_txt.innerHTML += "Votre ennemi a fait " + type[type_e] + "</br>";
        $("#playerAttack").attr("src","img/"+type[type_j]+".png");
        $("#enemiAttack").attr("src","img/"+type[type_e]+".png");
        var rslt;
        if (type_e == type_j) {
            rslt = 0;
            div_txt.innerHTML += "Egaliter !</br>";
            perso.goAttaque(ennemi, 1, div_txt);
            ennemi.goAttaque(perso, 1, div_txt);
        } else if ((type_e + 1) % 3 == type_j) {
            rslt = 1;
            div_txt.innerHTML += "Vous avez gagné !</br>";
            perso.goAttaque(ennemi, 2, div_txt);
        } else {
            rslt = 2;
            div_txt.innerHTML += "Vous avez perdu !</br>";
            ennemi.goAttaque(perso, 2, div_txt);
        }
        
    }
</script>
<div class="row">
    <div id="game" class="container-fluid">
        <?php include "header.phtml"; ?>
        <div class="row d-flex justify-content-center">
            <div class="col-lg-3 m-2 platform leftPlatform">
                <div class="lifeContainer">
                    <div class="lifeBar playerLifeBar">
                        <div class="lifePoint "><span id="vie_joueur">
                                <?php echo $character->vie ?> </span>/
                            <?php echo $character->vie ?>
                        </div>
                    </div>
                </div>
                <img class="battleCharacter" src="/MiniBoys/img/guerrier.png" alt="">
                <img class="platformImg" src="/MiniBoys/img/platformGreen.png" alt="">
            </div>
            <div class="col-lg-2  m-2 vs d-flex justify-content-center align-items-center">
               <div class="attack">
                   <img id="playerAttack" class="img-fluid" src="" alt="">
               </div>
                <div class="attack">
                    <img class="img-fluid" src="img/vs.png" alt="">
                </div>
                <div class="attack">
                    <img id="enemiAttack" class="img-fluid" src="" alt="">
                </div>
            </div>
            <div class="col-lg-3 m-2 platform rightPlatfrom">
                <div class="lifeContainer">
                    <div class="lifeBar enemiLifeBar">
                        <div class="lifePoint"> <span id="vie_ennemi">
                                <?php echo $ennemi->vie ?> </span>/
                            <?php echo $ennemi->vie ?>
                        </div>
                    </div>
                </div>
                <img class="battleCharacter" src="/MiniBoys/img/ladybug.png" alt="">
                <img class="platformImg" src="/MiniBoys/img/platformGreen.png" alt="">
            </div>
        </div>
        <div class="row fixed-bottom txtBattleContainer">
            <div class="battleBtnContainer d-flex justify-content-center">
                <button id="rock" class="battleBtn" onclick="bataille(0);"></button>
                <button id="leaf" class="battleBtn" onclick="bataille(1);"></button>
                <button id="scissor" class="battleBtn" onclick="bataille(2);"></button>
            </div>
            <div id='txt_bataille'>

            </div>
        </div>
    </div>

</div>
<script>
    function autoScrollOnclickBtn() {
        $(".battleBtn").click(function() {
            var scrollDimension = $("#txt_bataille")[0].scrollHeight;
            console.log(scrollDimension);
            $("#txt_bataille").scrollTop(scrollDimension);
        });
    }

    function animateLifeBar() {
        $(".battleBtn").click(function() {
            $(".playerLifeBar").animate({width: perso.current_vie+'%'});
            $(".enemiLifeBar").animate({width: ennemi.current_vie+'%'});
        });
    }
    autoScrollOnclickBtn();
    animateLifeBar();
</script>